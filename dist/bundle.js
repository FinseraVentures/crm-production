/*! For license information please see bundle.js.LICENSE.txt */
(()=>{"use strict";const e=require("dotenv"),t=require("path"),r=require("express"),n=require("cors"),o=require("morgan"),a=require("winston");require("winston-daily-rotate-file"),e.config({path:t.resolve(process.cwd(),".env")});var s=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,r=process.env[e];return void 0===r&&void 0===t&&console.warn("[ENV WARNING] Missing environment variable: ".concat(e)),null!=r?r:t},i=function(e){var t=process.env[e];if(!t)throw new Error("❌ Missing required environment variable: ".concat(e));return t},u=s("NODE_ENV","production"),c="development"===u,p="test"===u,l="production"===u;l&&(i("JWT_SECRET"),i("RAZORPAY_KEY_ID"),i("RAZORPAY_KEY_SECRET"));const d={nodeEnv:u,isDev:c,isTest:p,isProd:l,server:{port:s("PORT",5e3)},database:{uri:c?s("MONGO_URI_DEV",s("MONGO_URI")):p?s("MONGO_URI_TEST",s("MONGO_URI")):i("MONGO_URI_PROD"),backupUri:s(c?"MONGO_BACKUP_URI_DEV":p?"MONGO_BACKUP_URI_TEST":"MONGO_BACKUP_URI_PROD",s("MONGO_BACKUP_URI"))},auth:{jwtSecret:l?i("JWT_SECRET"):s("JWT_SECRET"),jwtExpiresIn:s("JWT_EXPIRES_IN","7d")},logging:{level:s("LOG_LEVEL",c?"debug":"info"),toConsole:"true"===s("LOG_TO_CONSOLE","true"),toFile:"true"===s("LOG_TO_FILE",l?"true":"false"),directory:s("LOG_DIRECTORY","logs"),compress:"true"===s("LOG_COMPRESS",l?"true":"false"),external:{host:s("LOG_EXTERNAL_HOST",""),port:s("LOG_EXTERNAL_PORT",""),token:s("LOG_EXTERNAL_TOKEN","")}},cors:{origin:s("CORS_ORIGIN","*")},rateLimit:{windowMs:s("RATE_LIMIT_WINDOW","15m"),max:s("RATE_LIMIT_MAX",100)},razorpay:{keyId:l?i("RAZORPAY_KEY_ID"):s("RAZORPAY_KEY_ID"),keySecret:l?i("RAZORPAY_KEY_SECRET"):s("RAZORPAY_KEY_SECRET")},appscript:{url:s("APPSCRIPT_URL"),secret:s("APPSCRIPT_SECRET")}};var f=a.createLogger,m=a.format,y=a.transports,v=[];d.logging.toConsole&&v.push(new y.Console({format:m.combine(m.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),m.printf(function(e){var t=e.timestamp,r=e.level,n=e.message;return"[".concat(t,"] ").concat(r.toUpperCase(),": ").concat(n)}))})),d.logging.toFile&&v.push(new y.DailyRotateFile({filename:"".concat(d.logging.directory,"/%DATE%-combined.txt"),datePattern:"YYYY-MM-DD",maxSize:"10m",maxFiles:"14d",zippedArchive:d.logging.compress,format:m.combine(m.timestamp(),m.json())}));const g=f({level:d.logging.level,transports:v}),b=o("combined",{stream:{write:function(e){g.info(e.trim())}}}),h=require("mongoose");console.log("User model loaded");var w=h.Schema({name:{type:String,required:!0},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},user_role:{type:String,required:!0},isActive:{type:Boolean,default:!1},resetPasswordToken:{type:String},resetPasswordExpires:{type:Date}},{timestamps:!1,versionKey:!1});const O=h.model("User",w);var S=h.Schema({user_id:{type:String,required:!0},bdm:{type:String,required:!0},branch_name:{type:String,required:!0},company_name:{type:String},contact_person:{type:String,required:!0},email:{type:String,required:!0},contact_no:{type:Number,required:!0},services:{type:[String],required:!0},closed_by:{type:String},total_amount:{type:Number,required:!0},term_1:{type:Number},term_2:{type:Number},term_3:{type:Number},payment_date:{type:Date},pan:{type:String},gst:{type:String},remark:{type:String},date:{type:Date,required:!0},after_disbursement:{type:String},bank:{type:String},state:{type:String,required:!0},status:{type:String},updatedhistory:[{updatedBy:String,updatedAt:{type:Date,default:Date.now},note:String,changes:{type:Map,of:new h.Schema({old:h.Schema.Types.Mixed,new:h.Schema.Types.Mixed},{_id:!1})}}],isDeleted:{type:Boolean,default:!1},deletedAt:{type:Date,default:null},deletedBy:{type:String,default:null}},{versionKey:!1,timestamps:!0});const k=h.model("Booking",S),_=require("crypto"),j=require("nodemailer"),P=require("bcrypt"),E=require("jsonwebtoken");function T(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return A(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(A(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,A(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,A(l,"constructor",c),A(c,"constructor",u),u.displayName="GeneratorFunction",A(c,o,"GeneratorFunction"),A(l),A(l,o,"Generator"),A(l,n,function(){return this}),A(l,"toString",function(){return"[object Generator]"}),(T=function(){return{w:a,m:d}})()}function A(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}A=function(e,t,r,n){function a(t,r){A(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},A(e,t,r,n)}function I(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}var N=function(){var e,t=(e=T().m(function e(t,r,n){var o,a;return T().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,o=t.headers.authorization){e.n=1;break}return e.a(2,r.status(401).send({message:"Authentication required"}));case 1:a=E.verify(o,process.env.JWT_SECRET),t.user=a,n(),e.n=3;break;case 2:return e.p=2,e.v,e.a(2,r.status(401).send({message:"Invalid or expired token"}));case 3:return e.a(2)}},e,null,[[0,2]])}),function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){I(a,n,o,s,i,"next",e)}function i(e){I(a,n,o,s,i,"throw",e)}s(void 0)})});return function(e,r,n){return t.apply(this,arguments)}}(),x=function(e,t,r){var n;if("srdev"!==(null===(n=e.user)||void 0===n?void 0:n.user_role))return t.status(403).send({message:"Access denied. Only devs can access this route."});r()};function q(e){return q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},q(e)}function R(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function G(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?R(Object(r),!0).forEach(function(t){D(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):R(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function D(e,t,r){return(t=function(e){var t=function(e){if("object"!=q(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=q(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==q(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function C(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return F(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(F(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,F(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,F(l,"constructor",c),F(c,"constructor",u),u.displayName="GeneratorFunction",F(c,o,"GeneratorFunction"),F(l),F(l,o,"Generator"),F(l,n,function(){return this}),F(l,"toString",function(){return"[object Generator]"}),(C=function(){return{w:a,m:d}})()}function F(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}F=function(e,t,r,n){function a(t,r){F(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},F(e,t,r,n)}function U(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}function B(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){U(a,n,o,s,i,"next",e)}function i(e){U(a,n,o,s,i,"throw",e)}s(void 0)})}}e.config();var M=r.Router();M.post("/adduser",N,x,function(){var e=B(C().m(function e(t,r){var n,o,a,s,i,u,c,p,l,d;return C().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,n=t.body,o=n.name,a=n.email,s=n.password,i=n.user_role,o&&a&&s){e.n=1;break}return e.a(2,r.status(400).send({message:"send all required fields: name, email, password"}));case 1:return u=a.toLowerCase(),e.n=2,O.findOne({email:u});case 2:if(!e.v){e.n=3;break}return e.a(2,r.status(409).send({message:"Email is already registered"}));case 3:return e.n=4,P.hash(s,5);case 4:return c=e.v,p={name:o,email:u,password:c,user_role:i},e.n=5,O.create(p);case 5:return l=e.v,e.a(2,r.status(201).send(l));case 6:return e.p=6,d=e.v,console.log(d.message),e.a(2,r.status(500).send({message:d.message}))}},e,null,[[0,6]])}));return function(t,r){return e.apply(this,arguments)}}()),M.patch("/edituser/:id",N,x,function(){var e=B(C().m(function e(t,r){var n,o,a,s;return C().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,n=t.params.id,(o=t.body)&&0!==Object.keys(o).length){e.n=1;break}return e.a(2,r.status(400).send({message:"No fields provided for update"}));case 1:if(!o.email){e.n=3;break}return o.email=o.email.toLowerCase(),e.n=2,O.findOne({email:o.email,_id:{$ne:n}});case 2:if(!e.v){e.n=3;break}return e.a(2,r.status(409).send({message:"Email is already registered"}));case 3:if(!o.password){e.n=5;break}return e.n=4,P.hash(o.password,5);case 4:o.password=e.v;case 5:return e.n=6,O.findByIdAndUpdate(n,{$set:o},{new:!0,runValidators:!0});case 6:if(a=e.v){e.n=7;break}return e.a(2,r.status(404).send({message:"User not found"}));case 7:return e.a(2,r.status(200).send({message:"User updated successfully",user:a}));case 8:return e.p=8,s=e.v,console.error(s.message),e.a(2,r.status(500).send({message:s.message}))}},e,null,[[0,8]])}));return function(t,r){return e.apply(this,arguments)}}()),M.delete("/deleteuser/:id",N,x,function(){var e=B(C().m(function e(t,r){var n,o;return C().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=t.params.id,e.n=1,O.findById(n);case 1:if(e.v){e.n=2;break}return e.a(2,r.status(404).send({message:"User not found"}));case 2:return e.n=3,O.findByIdAndDelete(n);case 3:return e.a(2,r.status(200).send({message:"User deleted successfully"}));case 4:return e.p=4,o=e.v,console.log(o.message),e.a(2,r.status(500).send({message:o.message}))}},e,null,[[0,4]])}));return function(t,r){return e.apply(this,arguments)}}()),M.get("/all",N,x,function(){var e=B(C().m(function e(t,r){var n,o;return C().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,O.find({}).select("-password");case 1:if(0!==(n=e.v).length){e.n=2;break}return e.a(2,r.status(404).send({message:"No Users found"}));case 2:n.length,r.status(200).send({Users:n}),e.n=4;break;case 3:return e.p=3,o=e.v,console.log(o.message),e.a(2,r.status(500).send({message:o.message}));case 4:return e.a(2)}},e,null,[[0,3]])}));return function(t,r){return e.apply(this,arguments)}}());var L=function(e){return E.sign({userId:e._id,user_role:e.user_role},process.env.JWT_SECRET,{expiresIn:"24h"})};M.post("/auth/login",function(){var e=B(C().m(function e(t,r){var n,o,a,s,i,u,c;return C().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,n=t.body,o=n.email,a=n.password,o&&a){e.n=1;break}return e.a(2,r.status(400).send({message:"Please provide both email and password."}));case 1:return e.n=2,O.findOneAndUpdate({email:o},{isActive:!0});case 2:if(s=e.v){e.n=3;break}return e.a(2,r.status(404).send({message:"User not found."}));case 3:return e.n=4,P.compare(a,s.password);case 4:if(e.v){e.n=5;break}return e.a(2,r.status(401).send({message:"Invalid email or password."}));case 5:i=L(s),delete(u=s.toObject()).password,r.status(200).json({success:!0,token:i,user:u}),e.n=7;break;case 6:return e.p=6,c=e.v,console.log(c.message),e.a(2,r.status(500).send({message:c.message}));case 7:return e.a(2)}},e,null,[[0,6]])}));return function(t,r){return e.apply(this,arguments)}}()),M.patch("/logout/:id",function(){var e=B(C().m(function e(t,r){var n,o,a;return C().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=t.params.id,e.p=1,e.n=2,O.findByIdAndUpdate(n,{isActive:!1});case 2:if(o=e.v){e.n=3;break}return e.a(2,r.status(404).send({message:"User not found."}));case 3:r.send(o),e.n=5;break;case 4:return e.p=4,a=e.v,e.a(2,r.status(500).send({message:a.message}));case 5:return e.a(2)}},e,null,[[1,4]])}));return function(t,r){return e.apply(this,arguments)}}()),M.get("/bookings/:id",N,function(){var e=B(C().m(function e(t,r){var n,o,a;return C().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.params.id,e.p=1,t.params.id){e.n=2;break}return e.a(2,r.status(400).send({message:"Not A VALID USER"}));case 2:return e.n=3,k.find({user_id:n});case 3:if(0!==(o=e.v).length){e.n=4;break}return e.a(2,r.status(404).send({message:"No bookings found for this user"}));case 4:r.status(200).send(o),e.n=6;break;case 5:return e.p=5,a=e.v,console.log(a.message),e.a(2,r.status(500).send({message:a.message}));case 6:return e.a(2)}},e,null,[[1,5]])}));return function(t,r){return e.apply(this,arguments)}}()),M.get("/:id?",N,function(){var e=B(C().m(function e(t,r){var n,o,a,s,i,u,c;return C().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.params.id,o=t.query.pattern,a=t.query.userRole,s=t.query.userId,parseInt(o),e.p=1,!n){e.n=7;break}if(!["dev","admin","senior admin","srdev"].includes(a)){e.n=3;break}return e.n=2,i.find({_id:n});case 2:i=e.v,e.n=5;break;case 3:return e.n=4,i.find({_id:n,user_id:s});case 4:i=e.v;case 5:if(0!==i.length){e.n=6;break}return e.a(2,r.status(404).send({message:"No bookings found with this id"}));case 6:e.n=14;break;case 7:if(!o){e.n=13;break}if(u={$or:[{company_name:{$regex:o,$options:"i"}},{contact_person:{$regex:o,$options:"i"}},{email:{$regex:o,$options:"i"}},{pan:{$regex:o,$options:"i"}},{gst:{$regex:o,$options:"i"}},{services:{$regex:o,$options:"i"}},{bdm:{$regex:o,$options:"i"}},{$expr:{$regexMatch:{input:{$toString:"$contact_no"},regex:o}}}]},!["dev","admin","senior admin","srdev"].includes(a)){e.n=9;break}return e.n=8,i.find(u);case 8:i=e.v,e.n=11;break;case 9:return e.n=10,i.find(G(G({},u),{},{user_id:s}));case 10:i=e.v;case 11:if(0!==i.length){e.n=12;break}return e.a(2,r.status(404).send({message:"No bookings found matching the pattern"}));case 12:e.n=14;break;case 13:return e.a(2,r.status(400).send({message:"Either id or pattern query parameter is required"}));case 14:r.status(200).send(i),e.n=16;break;case 15:return e.p=15,c=e.v,console.log(c.message),e.a(2,r.status(500).send({message:c.message}));case 16:return e.a(2)}},e,null,[[1,15]])}));return function(t,r){return e.apply(this,arguments)}}()),M.get("/:id",function(){var e=B(C().m(function e(t,r){var n,o,a;return C().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.params.id,e.p=1,t.params.id){e.n=2;break}return e.a(2,r.status(400).send({message:"Not A VALID USER"}));case 2:return e.n=3,o.find({_id:n});case 3:if(0!==(o=e.v).length){e.n=4;break}return e.a(2,r.status(404).send({message:"No User found with this id",status:!1}));case 4:r.status(200).send({message:"VALID USER",status:!0}),e.n=6;break;case 5:return e.p=5,a=e.v,console.log(a.message),e.a(2,r.status(500).send({message:a.message}));case 6:return e.a(2)}},e,null,[[1,5]])}));return function(t,r){return e.apply(this,arguments)}}()),M.put("/password-reset",function(){var e=B(C().m(function e(t,r){var n,o,a,s,i,u,c;return C().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.body,o=n.password,(a=n.email)&&o){e.n=1;break}return e.a(2,r.status(400).send({message:"Please provide both email and new password"}));case 1:return s=a.toLowerCase(),e.p=2,e.n=3,O.findOne({email:s});case 3:if(i=e.v){e.n=4;break}return e.a(2,r.status(404).send({message:"User not found with this email"}));case 4:return e.n=5,P.hash(o,5);case 5:return u=e.v,i.password=u,e.n=6,i.save();case 6:return e.a(2,r.status(200).send({message:"Password updated successfully"}));case 7:return e.p=7,c=e.v,console.log(c.message),e.a(2,r.status(500).send({message:c.message}))}},e,null,[[2,7]])}));return function(t,r){return e.apply(this,arguments)}}()),M.post("/request-reset-password",function(){var e=B(C().m(function e(t,r){var n,o,a,s,i,u,c;return C().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=t.body.email,e.p=1,e.n=2,O.findOne({email:n});case 2:if(o=e.v){e.n=3;break}return e.a(2,r.status(404).json({message:"User not found"}));case 3:return a=_.randomBytes(20).toString("hex"),s=Date.now()+36e5,o.resetPasswordToken=a,o.resetPasswordExpires=s,e.n=4,o.save();case 4:return i="http://localhost:5353/user/reset-password/".concat(a),u=j.createTransport({host:"smtp.hostinger.com",port:465,secure:!0,auth:{user:"siteadmin@enego.co.in",pass:"Siteadmin@enego@321"}}),c={to:o.email,from:"siteadmin@enego.co.in",subject:"Password Reset Request",text:"You are receiving this email because you (or someone else) have requested to reset the password for your account.\n\n\n      Please click the following link, or paste it into your browser to complete the process:\n\n\n      ".concat(i,"\n\n\n      If you did not request this, please ignore this email and your password will remain unchanged.")},e.n=5,u.sendMail(c);case 5:r.status(200).json({message:"Password reset link sent to your email."}),e.n=7;break;case 6:e.p=6,e.v,r.status(500).json({message:"Server error."});case 7:return e.a(2)}},e,null,[[1,6]])}));return function(t,r){return e.apply(this,arguments)}}()),M.post("/reset-password/:token",function(){var e=B(C().m(function e(t,r){var n,o,a,s,i;return C().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=t.params.token,o=t.body.newPassword,e.p=1,e.n=2,O.findOne({resetPasswordToken:n,resetPasswordExpires:{$gt:Date.now()}});case 2:if(a=e.v){e.n=3;break}return e.a(2,r.status(400).json({message:"Invalid or expired token"}));case 3:return e.n=4,P.genSalt(5);case 4:return s=e.v,e.n=5,P.hash(o,s);case 5:return i=e.v,a.password=i,a.resetPasswordToken=void 0,a.resetPasswordExpires=void 0,e.n=6,a.save();case 6:r.status(200).json({message:"Password reset successfully"}),e.n=8;break;case 7:e.p=7,e.v,r.status(500).json({message:"Server error"});case 8:return e.a(2)}},e,null,[[1,7]])}));return function(t,r){return e.apply(this,arguments)}}());const $=M;var Y=["services"];function V(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r={};for(var n in e)if({}.hasOwnProperty.call(e,n)){if(-1!==t.indexOf(n))continue;r[n]=e[n]}return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],-1===t.indexOf(r)&&{}.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}function K(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return H(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(H(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,H(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,H(l,"constructor",c),H(c,"constructor",u),u.displayName="GeneratorFunction",H(c,o,"GeneratorFunction"),H(l),H(l,o,"Generator"),H(l,n,function(){return this}),H(l,"toString",function(){return"[object Generator]"}),(K=function(){return{w:a,m:d}})()}function H(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}H=function(e,t,r,n){function a(t,r){H(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},H(e,t,r,n)}function W(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,o,a,s,i=[],u=!0,c=!1;try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;u=!1}else for(;!(u=(n=a.call(r)).done)&&(i.push(n.value),i.length!==t);u=!0);}catch(e){c=!0,o=e}finally{try{if(!u&&null!=r.return&&(s=r.return(),Object(s)!==s))return}finally{if(c)throw o}}return i}}(e,t)||function(e,t){if(e){if("string"==typeof e)return z(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?z(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function z(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function Q(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}function J(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){Q(a,n,o,s,i,"next",e)}function i(e){Q(a,n,o,s,i,"throw",e)}s(void 0)})}}var Z=r.Router();Z.post("/addbooking",N,function(){var e=J(K().m(function e(t,r){var n,o,a,s,i,u,c,p,l,d,f,m,y,v,g,b,h,w,O,S,_,j,P,E,T,A,I,N;return K().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.body,o=n.user_id,a=n.bdm,s=n.branch_name,i=n.company_name,u=n.contact_person,c=n.email,p=n.contact_no,l=n.services,d=n.total_amount,f=n.term_1,m=n.term_2,y=n.term_3,v=n.payment_date,g=n.closed_by,b=n.pan,h=n.gst,w=n.remark,O=n.date,S=n.status,_=n.bank,j=n.after_disbursement,P=n.state,E={branch_name:s,contact_person:u,user_id:o,bdm:a,email:c,services:l,total_amount:d,pan:b,state:P,date:O},T=Object.entries(E).filter(function(e){var t=W(e,2),r=t[0],n=t[1];return!n||"services"===r&&(!Array.isArray(n)||0===n.length)}).map(function(e){return W(e,1)[0]}),!(T.length>0)){e.n=1;break}return e.a(2,r.status(400).send({message:"Missing required fields: ".concat(T.join(", "))}));case 1:return e.p=1,A={user_id:o,bdm:a,branch_name:s,company_name:i||"",contact_person:u,email:c,contact_no:p,closed_by:g,services:l,total_amount:d,term_1:f,term_2:m,term_3:y,payment_date:v,pan:b,gst:h||"N/A",remark:w,date:O||new Date,status:S,bank:_,state:P,after_disbursement:j},e.n=2,k.create(A);case 2:return I=e.v,e.a(2,r.status(201).send({Message:"Booking Created Successfully",booking_id:I._id,booking:I}));case 3:return e.p=3,N=e.v,console.log(N),e.a(2,r.status(500).send({message:N.message}))}},e,null,[[1,3]])}));return function(t,r){return e.apply(this,arguments)}}()),Z.patch("/editbooking/:id",N,function(){var e=J(K().m(function e(t,r){var n,o,a,s,i,u,c,p,l,d,f,m,y,v,g,b,h;return K().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.params.id,o=t.body,a=t.headers["user-role"]){e.n=1;break}return e.a(2,r.status(400).send({message:"User role is required"}));case 1:return i=(s=o).updatedBy,u=s.note,delete o.updatedBy,delete o.note,e.p=2,e.n=3,k.findById(n);case 3:if(c=e.v){e.n=4;break}return e.a(2,r.status(404).send("Booking not found"));case 4:for(m in p=["dev","senior admin","srdev"],"admin"===a&&((l=o).services,d=V(l,Y),o=d),f={},o)y=c[m],v=o[m],Array.isArray(y)?JSON.stringify(y)!==JSON.stringify(v)&&(f[m]={old:y,new:v}):y!==v&&(f[m]={old:y,new:v});if(0!==Object.keys(f).length){e.n=5;break}return e.a(2,r.status(400).send({message:"No changes detected"}));case 5:if(g={updatedBy:i||"Unknown",updatedAt:new Date,note:u||"",changes:f},!p.includes(a)&&"admin"!==a){e.n=7;break}return e.n=6,k.findByIdAndUpdate(n,{$set:o,$push:{updatedhistory:g}},{new:!0});case 6:return b=e.v,e.a(2,r.status(200).send({message:"Booking Updated Successfully",updatedBooking:b}));case 7:return e.a(2,r.status(403).send({message:"You do not have permission to edit this booking"}));case 8:return e.p=8,h=e.v,e.a(2,r.status(500).send({message:h.message}))}},e,null,[[2,8]])}));return function(t,r){return e.apply(this,arguments)}}()),Z.patch("/trash/:id",N,function(){var e=J(K().m(function e(t,r){var n,o,a,s,i;return K().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.params.id,o=t.headers["user-role"],a=t.headers["user-name"],o&&["srdev","dev"].includes(o)){e.n=1;break}return e.a(2,r.status(403).send({message:"Only dev or srdev can move bookings to trash."}));case 1:return e.p=1,e.n=2,k.findByIdAndUpdate(n,{isDeleted:!0,deletedAt:new Date,deletedBy:a||"Unknown"},{new:!0});case 2:if(s=e.v){e.n=3;break}return e.a(2,r.status(404).send({message:"Booking not found"}));case 3:r.status(200).send({message:"Booking moved to trash",trashedBooking:s}),e.n=5;break;case 4:e.p=4,i=e.v,r.status(500).send({message:i.message});case 5:return e.a(2)}},e,null,[[1,4]])}));return function(t,r){return e.apply(this,arguments)}}()),Z.get("/trash",N,function(){var e=J(K().m(function e(t,r){var n,o,a;return K().w(function(e){for(;;)switch(e.p=e.n){case 0:if((n=t.headers["user-role"])&&"srdev"===n){e.n=1;break}return e.a(2,r.status(403).send({message:"Only srdev can view trash."}));case 1:return e.p=1,e.n=2,k.find({isDeleted:!0}).sort({deletedAt:-1});case 2:o=e.v,r.status(200).send(o),e.n=4;break;case 3:e.p=3,a=e.v,r.status(500).send({message:a.message});case 4:return e.a(2)}},e,null,[[1,3]])}));return function(t,r){return e.apply(this,arguments)}}()),Z.patch("/restore/:id",N,function(){var e=J(K().m(function e(t,r){var n,o,a,s;return K().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.params.id,(o=t.headers["user-role"])&&"srdev"===o){e.n=1;break}return e.a(2,r.status(403).send({message:"Only srdev can restore trashed bookings."}));case 1:return e.p=1,e.n=2,k.findByIdAndUpdate(n,{isDeleted:!1,deletedAt:null},{new:!0});case 2:if(a=e.v){e.n=3;break}return e.a(2,r.status(404).send({message:"Booking not found"}));case 3:r.status(200).send({message:"Booking restored successfully",restoredBooking:a}),e.n=5;break;case 4:e.p=4,s=e.v,r.status(500).send({message:s.message});case 5:return e.a(2)}},e,null,[[1,4]])}));return function(t,r){return e.apply(this,arguments)}}()),Z.delete("/deletebooking/:id",N,function(){var e=J(K().m(function e(t,r){var n,o,a;return K().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.params.id,"srdev"===t.headers["user-role"]){e.n=1;break}return e.a(2,r.status(403).send({message:"Only srdev can permanently delete bookings."}));case 1:return e.n=2,k.findById(n);case 2:if(o=e.v){e.n=3;break}return e.a(2,r.status(404).send({message:"Booking not found"}));case 3:if(o.isDeleted){e.n=4;break}return e.a(2,r.status(400).send({message:"You must move this booking to trash before deleting."}));case 4:return e.p=4,e.n=5,k.findByIdAndDelete(n);case 5:return e.a(2,r.status(200).send({message:"Booking permanently deleted."}));case 6:return e.p=6,a=e.v,e.a(2,r.status(500).send({message:a.message}))}},e,null,[[4,6]])}));return function(t,r){return e.apply(this,arguments)}}()),Z.get("/getbooking/:id",N,function(){var e=J(K().m(function e(t,r){var n,o,a;return K().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=t.params.id,e.p=1,e.n=2,k.findById(n);case 2:if(o=e.v){e.n=3;break}return e.a(2,r.status(404).send({message:"Booking not found"}));case 3:return e.a(2,r.status(200).send({booking:o}));case 4:return e.p=4,a=e.v,e.a(2,r.status(500).send({message:a.message}))}},e,null,[[1,4]])}));return function(t,r){return e.apply(this,arguments)}}()),Z.get("/all",N,function(){var e=J(K().m(function e(t,r){var n,o;return K().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,k.find({isDeleted:!1}).sort({createdAt:-1});case 1:if((n=e.v).length){e.n=2;break}return e.a(2,r.status(200).send({message:"No Bookings Found",Allbookings:[]}));case 2:return e.a(2,r.status(200).send({message:"All Bookings Fetched Successfully",Allbookings:n}));case 3:return e.p=3,o=e.v,console.error("Error in /all:",o.message),e.a(2,r.status(500).send({message:o.message}))}},e,null,[[0,3]])}));return function(t,r){return e.apply(this,arguments)}}()),Z.get("/bookings/filter",N,function(){var e=J(K().m(function e(t,r){var n,o,a,s,i,u,c,p,l,d,f,m,y,v,g,b,h,w,O,S,_,j,P,E,T,A;return K().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.query,o=n.startDate,a=n.endDate,s=n.status,i=n.service,u=n.userId,c=n.userRole,p=n.bdmName,l=n.paymentmode,d=n.paymentStartDate,f=n.paymentEndDate,m=n.page,y=void 0===m?1:m,v=n.limit,g=void 0===v?100:v,b=parseInt(y,10),h=parseInt(g,10),e.p=1,w={},!o||!a||d||f){e.n=3;break}if(O=new Date(o),S=new Date(a),!isNaN(O)&&!isNaN(S)){e.n=2;break}return e.a(2,r.status(400).send({message:"Invalid booking date format"}));case 2:S.setHours(23,59,59,999),w.date={$gte:O,$lte:S};case 3:if(!d||!f){e.n=5;break}if(_=new Date(d),j=new Date(f),!isNaN(_)&&!isNaN(j)){e.n=4;break}return e.a(2,r.status(400).send({message:"Invalid payment date format"}));case 4:j.setHours(23,59,59,999),w.payment_date={$gte:_,$lte:j};case 5:if(!s){e.n=7;break}if(["Pending","In Progress","Completed"].includes(s)){e.n=6;break}return e.a(2,r.status(400).send({message:"Invalid status value"}));case 6:w.status=new RegExp("^".concat(s.trim(),"$"),"i");case 7:if(i&&(w.services={$in:[i]}),!l){e.n=9;break}if(["Kotak Mahindra Bank","HDFC Bank","Razorpay","HDFC Gateway","CashFree Gateway","Phonepe Gateway","Enego Projects","Cash"].includes(l)){e.n=8;break}return e.a(2,r.status(400).send({message:"Invalid payment mode"}));case 8:w.bank=l;case 9:if(p&&(w.bdm={$regex:new RegExp(p,"i")}),P=["dev","admin","senior admin","srdev"],c&&P.includes(c)){e.n=11;break}if(u){e.n=10;break}return e.a(2,r.status(403).send({message:"Access forbidden. No valid role or user ID provided."}));case 10:w.user_id=u;case 11:return w.isDeleted=!1,e.n=12,k.countDocuments(w);case 12:return E=e.v,e.n=13,k.find(w).sort({createdAt:-1}).skip((b-1)*h).limit(h);case 13:if((T=e.v).length){e.n=14;break}return e.a(2,r.status(200).send([]));case 14:r.status(200).send({bookings:T,totalCount:E,totalPages:Math.ceil(E/h),currentPage:b}),e.n=16;break;case 15:e.p=15,A=e.v,console.error("Error in /bookings/filter:",A.message),r.status(500).send({message:A.message});case 16:return e.a(2)}},e,null,[[1,15]])}));return function(t,r){return e.apply(this,arguments)}}()),Z.get("/getbookings/user/:userId",N,function(){var e=J(K().m(function e(t,r){var n,o,a;return K().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=t.params.userId,e.p=1,e.n=2,k.find({user_id:n,isDeleted:!1}).sort({createdAt:-1});case 2:if((o=e.v).length){e.n=3;break}return e.a(2,r.status(200).send({message:"No bookings found for this user",bookings:[]}));case 3:return e.a(2,r.status(200).send({message:"User bookings fetched successfully",bookings:o}));case 4:return e.p=4,a=e.v,console.error("Error in /getbookings/user/:userId:",a.message),e.a(2,r.status(500).send({message:a.message}))}},e,null,[[1,4]])}));return function(t,r){return e.apply(this,arguments)}}());const X=Z;var ee=h.Schema({label:{type:String,required:!0},value:{type:String,required:!0,unique:!0},category:{type:String,default:""},processingTime:{type:String,default:""},status:{type:Boolean,required:!0,default:!0}},{timestamps:!1,versionKey:!1});const te=h.model("Service",ee);function re(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return ne(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(ne(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,ne(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,ne(l,"constructor",c),ne(c,"constructor",u),u.displayName="GeneratorFunction",ne(c,o,"GeneratorFunction"),ne(l),ne(l,o,"Generator"),ne(l,n,function(){return this}),ne(l,"toString",function(){return"[object Generator]"}),(re=function(){return{w:a,m:d}})()}function ne(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}ne=function(e,t,r,n){function a(t,r){ne(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},ne(e,t,r,n)}function oe(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}function ae(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){oe(a,n,o,s,i,"next",e)}function i(e){oe(a,n,o,s,i,"throw",e)}s(void 0)})}}var se=r.Router();se.post("/api/services",function(){var e=ae(re().m(function e(t,r){var n,o,a,s,i,u,c;return re().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.body,o=n.label,a=n.value,s=n.status,o&&a&&s){e.n=1;break}return e.a(2,r.status(400).send("Invalid input data"));case 1:return i={label:o,value:a,status:s},e.p=2,e.n=3,u.create(i);case 3:u=e.v,r.status(201).send({message:"Service added successfully",Service:u}),e.n=5;break;case 4:e.p=4,c=e.v,r.status(500).send({message:"Error adding service",error:c.message});case 5:return e.a(2)}},e,null,[[2,4]])}));return function(t,r){return e.apply(this,arguments)}}()),se.patch("/api/services/:id",N,x,function(){var e=ae(re().m(function e(t,r){var n,o,a,s;return re().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.params.id,(o=t.body)&&0!==Object.keys(o).length){e.n=1;break}return e.a(2,r.status(400).send({message:"No fields provided for update"}));case 1:return e.p=1,e.n=2,te.findByIdAndUpdate(n,{$set:o},{new:!0,runValidators:!0});case 2:if(a=e.v){e.n=3;break}return e.a(2,r.status(404).send({message:"Service not found"}));case 3:r.status(200).send({message:"Service updated successfully",service:a}),e.n=5;break;case 4:e.p=4,s=e.v,r.status(500).send({message:"Error updating service",error:s.message});case 5:return e.a(2)}},e,null,[[1,4]])}));return function(t,r){return e.apply(this,arguments)}}()),se.get("/api/services",N,function(){var e=ae(re().m(function e(t,r){var n,o;return re().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,te.find();case 1:if((n=e.v)&&0!==n.length){e.n=2;break}return e.a(2,r.status(404).send({message:"No services found"}));case 2:r.status(200).send(n),e.n=4;break;case 3:e.p=3,o=e.v,console.error("Error fetching services:",o),r.status(500).send({message:"Error fetching services",error:o.message});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(t,r){return e.apply(this,arguments)}}()),se.delete("/api/services/:id",N,x,function(){var e=ae(re().m(function e(t,r){var n,o,a;return re().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=t.params.id,e.p=1,e.n=2,te.findByIdAndDelete(n);case 2:if(o=e.v){e.n=3;break}return e.a(2,r.status(404).send({message:"Service not found"}));case 3:r.status(200).send({message:"Service deleted successfully",service:o}),e.n=5;break;case 4:e.p=4,a=e.v,r.status(500).send({message:"Error deleting service",error:a.message});case 5:return e.a(2)}},e,null,[[1,4]])}));return function(t,r){return e.apply(this,arguments)}}());const ie=se,ue=require("cloudinary"),ce=require("multer-storage-cloudinary"),pe=require("multer");function le(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return de(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(de(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,de(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,de(l,"constructor",c),de(c,"constructor",u),u.displayName="GeneratorFunction",de(c,o,"GeneratorFunction"),de(l),de(l,o,"Generator"),de(l,n,function(){return this}),de(l,"toString",function(){return"[object Generator]"}),(le=function(){return{w:a,m:d}})()}function de(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}de=function(e,t,r,n){function a(t,r){de(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},de(e,t,r,n)}function fe(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}for(var me=0,ye=["CLOUDINARY_CLOUD_NAME","CLOUDINARY_API_KEY","CLOUDINARY_API_SECRET"];me<ye.length;me++){var ve=ye[me];if(!process.env[ve])throw new Error("❌ Missing Cloudinary ENV: ".concat(ve))}ue.v2.config({cloud_name:process.env.CLOUDINARY_CLOUD_NAME,api_key:process.env.CLOUDINARY_API_KEY,api_secret:process.env.CLOUDINARY_API_SECRET});var ge,be,he=pe({storage:new ce.CloudinaryStorage({cloudinary:ue.v2,params:(ge=le().m(function e(t,r){var n,o,a,s,i;return le().w(function(e){for(;;)if(0===e.n)return o=Date.now(),a=(null===(n=t.user)||void 0===n?void 0:n.user_id)||"anonymous",s=r.originalname.split(".").pop(),i="".concat(a,"_").concat(r.fieldname,"_").concat(o,".").concat(s),e.a(2,{folder:"employee_profiles",public_id:i,allowed_formats:["jpg","jpeg","png"]})},e)}),be=function(){var e=this,t=arguments;return new Promise(function(r,n){var o=ge.apply(e,t);function a(e){fe(o,r,n,a,s,"next",e)}function s(e){fe(o,r,n,a,s,"throw",e)}a(void 0)})},function(e,t){return be.apply(this,arguments)})}),limits:{fileSize:5242880}});function we(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return Oe(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(Oe(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,Oe(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,Oe(l,"constructor",c),Oe(c,"constructor",u),u.displayName="GeneratorFunction",Oe(c,o,"GeneratorFunction"),Oe(l),Oe(l,o,"Generator"),Oe(l,n,function(){return this}),Oe(l,"toString",function(){return"[object Generator]"}),(we=function(){return{w:a,m:d}})()}function Oe(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}Oe=function(e,t,r,n){function a(t,r){Oe(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},Oe(e,t,r,n)}function Se(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}var ke=h.Schema({userId:{type:h.Schema.Types.ObjectId,ref:"User",required:!0},employeeFullName:{type:String,required:!0},employeeId:{type:h.Schema.Types.ObjectId,ref:"User",required:!0},designation:{type:String,required:!0},department:{type:String,required:!0,enum:["Sales","Digital","Admin","Legal","Finance"]},branch:{type:String,required:!0,enum:["Main Branch","407 AMD"]},gender:{type:String,required:!0,enum:["Male","Female","Other"]},maritalStatus:{type:String,required:!0,enum:["Single","Married","Divorced","Widowed"]},dateOfBirth:{type:Date,required:!0},personalContactNumber:{type:String,required:!0},personalEmailAddress:{type:String,required:!0,lowercase:!0,trim:!0},workEmail:{type:String,required:!0,lowercase:!0,trim:!0},workPhoneNumber:{type:String,required:!0},permanentAddress:{type:String,required:!0},currentAddress:{type:String,required:!0},emergencyContactName:{type:String,required:!0},emergencyContactNumber:{type:String,required:!0},emergencyContactRelationship:{type:String,required:!0,enum:["Father","Mother","Spouse","Brother","Sister","Friend","Other"]},dateOfJoining:{type:Date,required:!0},reportingManager:{type:String,required:!0},offeredSalary:{type:String,required:!0},dateOfLastPromotion:{type:Date},educationQualification:{type:String,required:!0},previousEmployer:{type:String},totalWorkExperience:{type:String,required:!0},accountNumber:{type:String,required:!0},bankName:{type:String,required:!0},ifscCode:{type:String,required:!0},panNumber:{type:String,required:!0,uppercase:!0,trim:!0},aadharNumber:{type:String,required:!0},employeePhoto:{type:String,required:!0},aadhaarCardPhoto:{type:String,required:!0},isActive:{type:Boolean,default:!0},profileCompletionStatus:{type:String,enum:["incomplete","pending_review","approved","rejected"],default:"pending_review"},createdBy:{type:String},updatedBy:{type:String},approvedBy:{type:String},approvedAt:{type:Date},updateHistory:[{updatedBy:{type:String,required:!0},updatedAt:{type:Date,default:Date.now},changes:{type:Map,of:{oldValue:h.Schema.Types.Mixed,newValue:h.Schema.Types.Mixed}},reason:{type:String}}]},{timestamps:!0,versionKey:!1});ke.pre("save",function(){var e=function(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){Se(a,n,o,s,i,"next",e)}function i(e){Se(a,n,o,s,i,"throw",e)}s(void 0)})}}(we().m(function e(t){var r,n,o,a,s,i;return we().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!this.isNew||this.employeeId){e.n=4;break}return e.p=1,r={Sales:"SL",Digital:"DG",Admin:"AD",Legal:"LG",Finance:"FN"}[this.department]||"EMP",n=(new Date).getFullYear().toString().slice(-2),e.n=2,this.constructor.findOne({employeeId:new RegExp("^".concat(r).concat(n))}).sort({employeeId:-1});case 2:o=e.v,a=1,o&&o.employeeId&&(s=parseInt(o.employeeId.slice(-4)),a=s+1),this.employeeId="".concat(r).concat(n).concat(a.toString().padStart(4,"0")),this.createdBy=this.userId,e.n=4;break;case 3:return e.p=3,i=e.v,e.a(2,t(i));case 4:t();case 5:return e.a(2)}},e,this,[[1,3]])}));return function(t){return e.apply(this,arguments)}}()),ke.index({userId:1}),ke.index({employeeId:1}),ke.index({department:1}),ke.index({branch:1}),ke.index({personalEmailAddress:1}),ke.index({workEmail:1});const _e=h.model("Employee",ke);function je(e){return je="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},je(e)}function Pe(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Ee(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Pe(Object(r),!0).forEach(function(t){Te(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Pe(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function Te(e,t,r){return(t=function(e){var t=function(e){if("object"!=je(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=je(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==je(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ae(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return Ie(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(Ie(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,Ie(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,Ie(l,"constructor",c),Ie(c,"constructor",u),u.displayName="GeneratorFunction",Ie(c,o,"GeneratorFunction"),Ie(l),Ie(l,o,"Generator"),Ie(l,n,function(){return this}),Ie(l,"toString",function(){return"[object Generator]"}),(Ae=function(){return{w:a,m:d}})()}function Ie(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}Ie=function(e,t,r,n){function a(t,r){Ie(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},Ie(e,t,r,n)}function Ne(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,o,a,s,i=[],u=!0,c=!1;try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;u=!1}else for(;!(u=(n=a.call(r)).done)&&(i.push(n.value),i.length!==t);u=!0);}catch(e){c=!0,o=e}finally{try{if(!u&&null!=r.return&&(s=r.return(),Object(s)!==s))return}finally{if(c)throw o}}return i}}(e,t)||function(e,t){if(e){if("string"==typeof e)return xe(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?xe(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function xe(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function qe(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}function Re(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){qe(a,n,o,s,i,"next",e)}function i(e){qe(a,n,o,s,i,"throw",e)}s(void 0)})}}var Ge=r.Router(),De=function(e,t,r){if("HR"!==e.user.user_role)return t.status(403).json({message:"Access denied. Only HR personnel can perform this action."});r()};Ge.use(N),Ge.get("/all",De,function(){var e=Re(Ae().m(function e(t,r){var n,o,a,s,i,u,c,p,l,d,f,m,y,v,g,b;return Ae().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=t.query,o=n.page,a=void 0===o?1:o,s=n.limit,i=void 0===s?50:s,u=n.department,c=n.branch,p=n.status,l=n.search,d={isActive:!0},u&&(d.department=u),c&&(d.branch=c),p&&(d.profileCompletionStatus=p),l&&(d.$or=[{employeeFullName:{$regex:l,$options:"i"}},{employeeId:{$regex:l,$options:"i"}},{personalEmailAddress:{$regex:l,$options:"i"}},{workEmail:{$regex:l,$options:"i"}}]),f=(parseInt(a)-1)*parseInt(i),e.n=1,Promise.all([_e.find(d).select("-updateHistory -__v").sort({createdAt:-1}).skip(f).limit(parseInt(i)),_e.countDocuments(d)]);case 1:m=e.v,y=Ne(m,2),v=y[0],g=y[1],r.json({employees:v,pagination:{currentPage:parseInt(a),totalPages:Math.ceil(g/parseInt(i)),totalEmployees:g,hasNext:f+v.length<g,hasPrev:parseInt(a)>1}}),e.n=3;break;case 2:e.p=2,b=e.v,console.error("GET /all error:",b),r.status(500).json({error:"Server error",details:b.message});case 3:return e.a(2)}},e,null,[[0,2]])}));return function(t,r){return e.apply(this,arguments)}}()),Ge.get("/profile/:id",function(e,t,r){var n=e.params.id;if(e.user.userId!==n&&"HR"!==e.user.role)return t.status(403).json({message:"Access denied. You can only access your own profile or need HR privileges."});r()},function(){var e=Re(Ae().m(function e(t,r){var n,o;return Ae().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,_e.findOne({userId:t.params.id,isActive:!0}).select("-updateHistory -__v");case 1:if(n=e.v){e.n=2;break}return e.a(2,r.status(404).json({error:"Profile not found"}));case 2:r.json({profile:n}),e.n=4;break;case 3:e.p=3,o=e.v,console.error("GET /profile/:id error:",o),r.status(500).json({error:"Server error",details:o.message});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(t,r){return e.apply(this,arguments)}}()),Ge.post("/profile",he.fields([{name:"employeePhoto",maxCount:1},{name:"aadhaarCardPhoto",maxCount:1}]),function(e,t,r){var n=["employeeFullName","designation","department","branch","gender","maritalStatus","dateOfBirth","personalContactNumber","personalEmailAddress","workEmail","workPhoneNumber","permanentAddress","currentAddress","emergencyContactName","emergencyContactNumber","emergencyContactRelationship","dateOfJoining","reportingManager","offeredSalary","educationQualification","totalWorkExperience","accountNumber","bankName","ifscCode","panNumber","aadharNumber"].filter(function(t){return!e.body[t]});if(n.length>0)return t.status(400).json({error:"Missing required fields",missingFields:n});var o=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!o.test(e.body.personalEmailAddress)||!o.test(e.body.workEmail))return t.status(400).json({error:"Invalid email format"});var a=/^\d{10}$/;return a.test(e.body.personalContactNumber.replace(/\D/g,""))&&a.test(e.body.workPhoneNumber.replace(/\D/g,""))?/^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(e.body.panNumber.toUpperCase())?/^\d{12}$/.test(e.body.aadharNumber.replace(/\D/g,""))?void r():t.status(400).json({error:"Invalid Aadhar number format"}):t.status(400).json({error:"Invalid PAN number format"}):t.status(400).json({error:"Invalid phone number format"})},function(){var e=Re(Ae().m(function e(t,r){var n,o,a,s,i,u,c;return Ae().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,_e.findOne({userId:t.user.userId});case 1:if(!e.v){e.n=2;break}return e.a(2,r.status(400).json({error:"Profile already exists for this user"}));case 2:if(null!==(n=t.files)&&void 0!==n&&n.employeePhoto&&null!==(o=t.files)&&void 0!==o&&o.aadhaarCardPhoto){e.n=3;break}return e.a(2,r.status(400).json({error:"Both employee photo and Aadhaar card photo are required"}));case 3:return e.n=4,_e.findOne({$or:[{personalEmailAddress:t.body.personalEmailAddress.toLowerCase()},{workEmail:t.body.workEmail.toLowerCase()}]});case 4:if(!e.v){e.n=5;break}return e.a(2,r.status(400).json({error:"Email address already exists in the system"}));case 5:return a=Ee(Ee({userId:t.user.userId},t.body),{},{personalEmailAddress:t.body.personalEmailAddress.toLowerCase(),workEmail:t.body.workEmail.toLowerCase(),panNumber:t.body.panNumber.toUpperCase(),employeePhoto:t.files.employeePhoto[0].path,aadhaarCardPhoto:t.files.aadhaarCardPhoto[0].path,createdBy:t.user.userId}),s=new _e(a),e.n=6,s.save();case 6:delete(i=s.toObject()).updateHistory,r.status(201).json({message:"Employee profile created successfully",profile:i}),e.n=9;break;case 7:if(e.p=7,c=e.v,console.error("POST /profile error:",c),11e3!==c.code){e.n=8;break}return u=Object.keys(c.keyPattern)[0],e.a(2,r.status(400).json({error:"".concat(u," already exists in the system")}));case 8:r.status(500).json({error:"Server error",details:c.message});case 9:return e.a(2)}},e,null,[[0,7]])}));return function(t,r){return e.apply(this,arguments)}}()),Ge.put("/update/:id",De,function(){var e=Re(Ae().m(function e(t,r){var n,o,a,s,i,u,c,p;return Ae().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,_e.findOne({userId:t.params.id,isActive:!0});case 1:if(a=e.v){e.n=2;break}return e.a(2,r.status(404).json({error:"Profile not found"}));case 2:if(s=new Map,i={},["employeeFullName","designation","department","branch","gender","maritalStatus","dateOfBirth","personalContactNumber","personalEmailAddress","workEmail","workPhoneNumber","permanentAddress","currentAddress","emergencyContactName","emergencyContactNumber","emergencyContactRelationship","dateOfJoining","reportingManager","dateOfLastPromotion","educationQualification","previousEmployer","totalWorkExperience","accountNumber","bankName","ifscCode","panNumber","aadharNumber"].forEach(function(e){void 0!==t.body[e]&&t.body[e]!==a[e]&&(s.set(e,{oldValue:a[e],newValue:t.body[e]}),i[e]=t.body[e])}),null!==(n=t.files)&&void 0!==n&&n.employeePhoto&&(s.set("employeePhoto",{oldValue:a.employeePhoto,newValue:t.files.employeePhoto[0].path}),i.employeePhoto=t.files.employeePhoto[0].path),null!==(o=t.files)&&void 0!==o&&o.aadhaarCardPhoto&&(s.set("aadhaarCardPhoto",{oldValue:a.aadhaarCardPhoto,newValue:t.files.aadhaarCardPhoto[0].path}),i.aadhaarCardPhoto=t.files.aadhaarCardPhoto[0].path),0!==Object.keys(i).length){e.n=3;break}return e.a(2,r.status(400).json({message:"No changes detected"}));case 3:return i.updatedBy=t.user.userId,i.$push={updateHistory:{updatedBy:t.user.userId,changes:s,reason:t.body.updateReason||"Profile update"}},e.n=4,_e.findOneAndUpdate({userId:t.params.id},i,{new:!0,runValidators:!0}).select("-updateHistory -__v");case 4:u=e.v,r.json({message:"Profile updated successfully",profile:u,changesCount:s.size}),e.n=7;break;case 5:if(e.p=5,p=e.v,console.error("PUT /update/:id error:",p),11e3!==p.code){e.n=6;break}return c=Object.keys(p.keyPattern)[0],e.a(2,r.status(400).json({error:"".concat(c," already exists in the system")}));case 6:r.status(500).json({error:"Server error",details:p.message});case 7:return e.a(2)}},e,null,[[0,5]])}));return function(t,r){return e.apply(this,arguments)}}()),Ge.delete("/delete/:id",De,function(){var e=Re(Ae().m(function e(t,r){var n,o;return Ae().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,_e.findOneAndUpdate({userId:t.params.id,isActive:!0},{isActive:!1,updatedBy:t.user.userId,$push:{updateHistory:{updatedBy:t.user.userId,changes:new Map([["isActive",{oldValue:!0,newValue:!1}]]),reason:t.body.reason||"Profile deactivated"}}},{new:!0});case 1:if(n=e.v){e.n=2;break}return e.a(2,r.status(404).json({error:"Profile not found"}));case 2:r.json({message:"Employee profile deactivated successfully",employeeId:n.employeeId}),e.n=4;break;case 3:e.p=3,o=e.v,console.error("DELETE /delete/:id error:",o),r.status(500).json({error:"Server error",details:o.message});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(t,r){return e.apply(this,arguments)}}()),Ge.post("/approve/:id",De,function(){var e=Re(Ae().m(function e(t,r){var n,o;return Ae().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,_e.findOneAndUpdate({userId:t.params.id,isActive:!0},{profileCompletionStatus:"approved",approvedBy:t.user.userId,approvedAt:new Date,updatedBy:t.user.userId,$push:{updateHistory:{updatedBy:t.user.userId,changes:new Map([["profileCompletionStatus",{oldValue:"pending_review",newValue:"approved"}]]),reason:"Profile approved by HR"}}},{new:!0}).select("-updateHistory -__v");case 1:if(n=e.v){e.n=2;break}return e.a(2,r.status(404).json({error:"Profile not found"}));case 2:r.json({message:"Employee profile approved successfully",profile:n}),e.n=4;break;case 3:e.p=3,o=e.v,console.error("POST /approve/:id error:",o),r.status(500).json({error:"Server error",details:o.message});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(t,r){return e.apply(this,arguments)}}()),Ge.get("/stats",De,function(){var e=Re(Ae().m(function e(t,r){var n,o,a,s,i,u,c,p;return Ae().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,Promise.all([_e.countDocuments({isActive:!0}),_e.aggregate([{$match:{isActive:!0}},{$group:{_id:"$department",count:{$sum:1}}},{$sort:{count:-1}}]),_e.aggregate([{$match:{isActive:!0}},{$group:{_id:"$branch",count:{$sum:1}}},{$sort:{count:-1}}]),_e.aggregate([{$match:{isActive:!0}},{$group:{_id:"$profileCompletionStatus",count:{$sum:1}}}]),_e.find({isActive:!0}).sort({dateOfJoining:-1}).limit(5).select("employeeFullName employeeId department dateOfJoining")]);case 1:n=e.v,o=Ne(n,5),a=o[0],s=o[1],i=o[2],u=o[3],c=o[4],r.json({totalEmployees:a,departmentStats:s,branchStats:i,statusStats:u,recentJoinees:c}),e.n=3;break;case 2:e.p=2,p=e.v,console.error("GET /stats error:",p),r.status(500).json({error:"Server error",details:p.message});case 3:return e.a(2)}},e,null,[[0,2]])}));return function(t,r){return e.apply(this,arguments)}}()),Ge.get("/export",De,function(){var e=Re(Ae().m(function e(t,r){var n,o,a,s,i,u,c,p,l,d;return Ae().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=t.query,o=n.format,a=void 0===o?"json":o,s=n.department,i=n.branch,u={isActive:!0},s&&(u.department=s),i&&(u.branch=i),e.n=1,_e.find(u).select("-updateHistory -__v -employeePhoto -aadhaarCardPhoto").sort({employeeId:1});case 1:c=e.v,"csv"===a?(p=["Employee ID","Full Name","Designation","Department","Branch","Personal Email","Work Email","Personal Phone","Work Phone","Date of Joining","Reporting Manager"].join(","),l=c.map(function(e){var t;return[e.employeeId,e.employeeFullName,e.designation,e.department,e.branch,e.personalEmailAddress,e.workEmail,e.personalContactNumber,e.workPhoneNumber,(null===(t=e.dateOfJoining)||void 0===t?void 0:t.toISOString().split("T")[0])||"",e.reportingManager].join(",")}).join("\n"),r.setHeader("Content-Type","text/csv"),r.setHeader("Content-Disposition","attachment; filename=employees.csv"),r.send(p+"\n"+l)):r.json({employees:c,count:c.length}),e.n=3;break;case 2:e.p=2,d=e.v,console.error("GET /export error:",d),r.status(500).json({error:"Server error",details:d.message});case 3:return e.a(2)}},e,null,[[0,2]])}));return function(t,r){return e.apply(this,arguments)}}());const Ce=Ge;var Fe=h.Schema({invoiceNumber:{type:String,required:!0},date:{type:String,required:!0},clientCompanyName:{type:String,required:!0},clientName:{type:String,required:!0},clientEmail:{type:String,required:!0},clientAddress:{type:String},clientGstNumber:{type:Number},items:{type:Array,required:!0},subtotal:{type:Number,required:!0},gstRate:{type:Number},gstAmount:{type:Number,required:!0},total:{type:Number,required:!0},includeGst:{type:Boolean},user:{type:h.Schema.Types.ObjectId,ref:"User",required:!0}},{timestamps:!1,versionKey:!1});const Ue=h.model("Invoice",Fe);function Be(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return Me(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(Me(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,Me(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,Me(l,"constructor",c),Me(c,"constructor",u),u.displayName="GeneratorFunction",Me(c,o,"GeneratorFunction"),Me(l),Me(l,o,"Generator"),Me(l,n,function(){return this}),Me(l,"toString",function(){return"[object Generator]"}),(Be=function(){return{w:a,m:d}})()}function Me(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}Me=function(e,t,r,n){function a(t,r){Me(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},Me(e,t,r,n)}function Le(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}function $e(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){Le(a,n,o,s,i,"next",e)}function i(e){Le(a,n,o,s,i,"throw",e)}s(void 0)})}}var Ye=r.Router();Ye.post("/",function(){var e=$e(Be().m(function e(t,r){var n,o;return Be().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=new Ue(t.body),e.n=1,n.save();case 1:r.status(201).json(n),e.n=3;break;case 2:e.p=2,o=e.v,r.status(400).json({error:o.message});case 3:return e.a(2)}},e,null,[[0,2]])}));return function(t,r){return e.apply(this,arguments)}}()),Ye.get("/",function(){var e=$e(Be().m(function e(t,r){var n,o;return Be().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,Ue.find();case 1:n=e.v,r.json(n),e.n=3;break;case 2:e.p=2,o=e.v,r.status(500).json({error:o.message});case 3:return e.a(2)}},e,null,[[0,2]])}));return function(t,r){return e.apply(this,arguments)}}()),Ye.get("/:id",function(){var e=$e(Be().m(function e(t,r){var n,o;return Be().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,Ue.findById(t.params.id);case 1:if(n=e.v){e.n=2;break}return e.a(2,r.status(404).json({error:"Invoice not found"}));case 2:r.json(n),e.n=4;break;case 3:e.p=3,o=e.v,r.status(500).json({error:o.message});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(t,r){return e.apply(this,arguments)}}()),Ye.put("/:id",function(){var e=$e(Be().m(function e(t,r){var n,o;return Be().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,Ue.findByIdAndUpdate(t.params.id,t.body,{new:!0});case 1:if(n=e.v){e.n=2;break}return e.a(2,r.status(404).json({error:"Invoice not found"}));case 2:r.json(n),e.n=4;break;case 3:e.p=3,o=e.v,r.status(400).json({error:o.message});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(t,r){return e.apply(this,arguments)}}()),Ye.delete("/:id",function(){var e=$e(Be().m(function e(t,r){var n;return Be().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,Ue.findByIdAndDelete(t.params.id);case 1:if(e.v){e.n=2;break}return e.a(2,r.status(404).json({error:"Invoice not found"}));case 2:r.json({message:"Invoice deleted"}),e.n=4;break;case 3:e.p=3,n=e.v,r.status(500).json({error:n.message});case 4:return e.a(2)}},e,null,[[0,3]])}));return function(t,r){return e.apply(this,arguments)}}());const Ve=Ye;var Ke=h.Schema({name:{type:String,required:!0},companyName:{type:String},phoneNumber:{type:String,required:!0},email:{type:String,required:!0},location:{type:String},service:{type:String},message:{type:String},assignedTo:{type:String,required:!0,default:"unassigned"}},{timestamps:!0,versionKey:!1});const He=h.model("Email",Ke);function We(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return ze(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(ze(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,ze(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,ze(l,"constructor",c),ze(c,"constructor",u),u.displayName="GeneratorFunction",ze(c,o,"GeneratorFunction"),ze(l),ze(l,o,"Generator"),ze(l,n,function(){return this}),ze(l,"toString",function(){return"[object Generator]"}),(We=function(){return{w:a,m:d}})()}function ze(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}ze=function(e,t,r,n){function a(t,r){ze(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},ze(e,t,r,n)}function Qe(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}function Je(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){Qe(a,n,o,s,i,"next",e)}function i(e){Qe(a,n,o,s,i,"throw",e)}s(void 0)})}}var Ze=r.Router();Ze.get("/all",function(){var e=Je(We().m(function e(t,r){var n,o,a,s,i;return We().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=Number(t.query.page)||1,o=Number(t.query.limit)||50,a=(n-1)*o,e.n=1,He.find({assignedTo:"unassigned",isDeleted:!1},{name:1,companyName:1,phoneNumber:1,email:1,location:1,service:1,createdAt:1,assignedTo:1}).sort({createdAt:-1}).skip(a).limit(o).lean();case 1:return s=e.v,e.a(2,r.status(200).send({page:n,limit:o,count:s.length,leads:s}));case 2:return e.p=2,i=e.v,console.error(i),e.a(2,r.status(500).send({message:i.message}))}},e,null,[[0,2]])}));return function(t,r){return e.apply(this,arguments)}}()),Ze.patch("/edit/:id",N,function(){var e=Je(We().m(function e(t,r){var n,o,a,s,i;return We().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=t.params.id,o=t.body,e.p=1,e.n=2,He.findById(n);case 2:if((a=e.v)&&!a.isDeleted){e.n=3;break}return e.a(2,r.status(404).send({message:"Lead not found"}));case 3:return e.n=4,He.findByIdAndUpdate(n,{$set:o},{new:!0});case 4:return s=e.v,e.a(2,r.status(200).send({message:"Lead updated",updated:s}));case 5:return e.p=5,i=e.v,console.error(i),e.a(2,r.status(500).send({message:i.message}))}},e,null,[[1,5]])}));return function(t,r){return e.apply(this,arguments)}}()),Ze.patch("/trash/:id",N,function(){var e=Je(We().m(function e(t,r){var n,o,a,s;return We().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=t.params.id,o=t.headers["user-name"]||"Unknown",e.p=1,e.n=2,He.findById(n);case 2:if((a=e.v)&&!a.isDeleted){e.n=3;break}return e.a(2,r.status(404).send({message:"Lead not found"}));case 3:return a.isDeleted=!0,a.deletedAt=new Date,a.deletedBy=o,e.n=4,a.save();case 4:return e.a(2,r.status(200).send({message:"Lead moved to trash",lead:a}));case 5:return e.p=5,s=e.v,console.error(s),e.a(2,r.status(500).send({message:s.message}))}},e,null,[[1,5]])}));return function(t,r){return e.apply(this,arguments)}}()),Ze.delete("/delete/:id",N,function(){var e=Je(We().m(function e(t,r){var n,o;return We().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.params.id,"srdev"===t.headers["user-role"]){e.n=1;break}return e.a(2,r.status(403).send({message:"Only srdev can permanently delete leads."}));case 1:return e.p=1,e.n=2,He.findById(n);case 2:if(e.v){e.n=3;break}return e.a(2,r.status(404).send({message:"Lead not found"}));case 3:return e.n=4,He.findByIdAndDelete(n);case 4:return e.a(2,r.status(200).send({message:"Lead permanently deleted"}));case 5:return e.p=5,o=e.v,console.error(o),e.a(2,r.status(500).send({message:o.message}))}},e,null,[[1,5]])}));return function(t,r){return e.apply(this,arguments)}}());const Xe=Ze;function et(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return tt(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(tt(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,tt(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,tt(l,"constructor",c),tt(c,"constructor",u),u.displayName="GeneratorFunction",tt(c,o,"GeneratorFunction"),tt(l),tt(l,o,"Generator"),tt(l,n,function(){return this}),tt(l,"toString",function(){return"[object Generator]"}),(et=function(){return{w:a,m:d}})()}function tt(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}tt=function(e,t,r,n){function a(t,r){tt(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},tt(e,t,r,n)}function rt(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}function nt(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){rt(a,n,o,s,i,"next",e)}function i(e){rt(a,n,o,s,i,"throw",e)}s(void 0)})}}var ot=r.Router();ot.post("/login",function(){var e=nt(et().m(function e(t,r){var n,o,a,s,i,u;return et().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,n=t.body,o=n.email,a=n.password,o&&a){e.n=1;break}return e.a(2,r.status(400).send({message:"Please provide both email and password."}));case 1:return e.n=2,O.findOneAndUpdate({email:o},{isActive:!0});case 2:if(s=e.v){e.n=3;break}return e.a(2,r.status(404).send({message:"User not found."}));case 3:return e.n=4,P.compare(a,s.password);case 4:if(e.v){e.n=5;break}return e.a(2,r.status(401).send({message:"Invalid email or password."}));case 5:i=at(s),r.status(200).send({token:i,user:s}),e.n=7;break;case 6:return e.p=6,u=e.v,console.log(u.message),e.a(2,r.status(500).send({message:u.message}));case 7:return e.a(2)}},e,null,[[0,6]])}));return function(t,r){return e.apply(this,arguments)}}()),ot.patch("/logout/:id",function(){var e=nt(et().m(function e(t,r){var n,o,a;return et().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=t.params.id,e.p=1,e.n=2,O.findByIdAndUpdate(n,{isActive:!1});case 2:if(o=e.v){e.n=3;break}return e.a(2,r.status(404).send({message:"User not found."}));case 3:r.send(o),e.n=5;break;case 4:return e.p=4,a=e.v,e.a(2,r.status(500).send({message:a.message}));case 5:return e.a(2)}},e,null,[[1,4]])}));return function(t,r){return e.apply(this,arguments)}}());var at=function(e){return E.sign({userId:e._id,user_role:e.user_role},process.env.JWT_SECRET,{expiresIn:"24h"})};const st=ot,it=require("razorpay");function ut(e){return ut="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ut(e)}function ct(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return pt(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(pt(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,pt(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,pt(l,"constructor",c),pt(c,"constructor",u),u.displayName="GeneratorFunction",pt(c,o,"GeneratorFunction"),pt(l),pt(l,o,"Generator"),pt(l,n,function(){return this}),pt(l,"toString",function(){return"[object Generator]"}),(ct=function(){return{w:a,m:d}})()}function pt(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}pt=function(e,t,r,n){function a(t,r){pt(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},pt(e,t,r,n)}function lt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function dt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?lt(Object(r),!0).forEach(function(t){ft(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):lt(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function ft(e,t,r){return(t=function(e){var t=function(e){if("object"!=ut(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=ut(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==ut(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function mt(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}var yt=process.env.APPSCRIPT_URL,vt=process.env.APPSCRIPT_SECRET;function gt(e){return bt.apply(this,arguments)}function bt(){return bt=function(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){mt(a,n,o,s,i,"next",e)}function i(e){mt(a,n,o,s,i,"throw",e)}s(void 0)})}}(ct().m(function e(t){var r,n,o;return ct().w(function(e){for(;;)switch(e.n){case 0:if(yt){e.n=1;break}throw new Error("APPSCRIPT_URL not configured");case 1:return r=dt(dt({},t),{},{__secret:vt}),console.log(t,"Payload"),e.n=2,fetch(yt,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});case 2:return n=e.v,e.n=3,n.json().catch(function(){return null});case 3:if((o=e.v)&&o.success){e.n=4;break}throw console.error("Failed to append to Google Sheet",o),new Error((null==o?void 0:o.message)||"Failed to append to Google Sheet");case 4:return e.a(2,o)}},e)})),bt.apply(this,arguments)}var ht=new h.Schema({customerName:{type:String,required:!0,trim:!0},contact:{type:String,required:!0,trim:!0},amount:{type:Number,required:!0,min:1},user:{type:h.Schema.Types.ObjectId,ref:"User",required:!0},description:{type:String,trim:!0,default:""},link:{type:String,required:!0,unique:!0,trim:!0},status:{type:String,enum:["pending","paid","expired","failed"],default:"pending"}},{timestamps:!0});const wt=h.model("PaymentLink",ht);var Ot=new h.Schema({name:{type:String,required:!0},user:{type:h.Schema.Types.ObjectId,ref:"User",required:!0},amount:{type:Number,required:!0},description:{type:String},qr_id:{type:String,required:!0,unique:!0},qr_image:{type:String},qr_base64:{type:String},usage:{type:String,default:"single_use"},purpose:{type:String,default:"UPI QR Payment"},fixed_amount:{type:Boolean,default:!0},close_by:{type:Number},status:{type:String,default:"Pending",enum:["Pending","Paid","Expired","Cancelled"]}},{timestamps:!0});const St=h.model("PaymentQr",Ot);function kt(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return _t(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(_t(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,_t(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,_t(l,"constructor",c),_t(c,"constructor",u),u.displayName="GeneratorFunction",_t(c,o,"GeneratorFunction"),_t(l),_t(l,o,"Generator"),_t(l,n,function(){return this}),_t(l,"toString",function(){return"[object Generator]"}),(kt=function(){return{w:a,m:d}})()}function _t(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}_t=function(e,t,r,n){function a(t,r){_t(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},_t(e,t,r,n)}function jt(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}function Pt(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){jt(a,n,o,s,i,"next",e)}function i(e){jt(a,n,o,s,i,"throw",e)}s(void 0)})}}e.config();var Et=r.Router(),Tt=new it({key_id:process.env.RAZORPAY_KEY_ID,key_secret:process.env.RAZORPAY_KEY_SECRET});Et.post("/create-upi-link",N,function(){var e=Pt(kt().m(function e(t,r){var n,o,a,s,i,u,c,p,l,d,f,m,y,v,g,b;return kt().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,n=t.body,o=n.amount,a=n.name,s=n.email,i=n.phone,u=n.description,c=n.notifyEmail,p=void 0===c||c,l=n.notifySms,d=void 0===l||l,f=n.user,m=n.userName,console.log(t.body),o&&s&&i){e.n=1;break}return e.a(2,r.status(400).json({message:"Amount, email & phone are required."}));case 1:return e.n=2,Tt.paymentLink.create({amount:Math.round(100*o),currency:"INR",accept_partial:!1,description:u||"UPI Payment",customer:{name:a||"Customer",email:s,contact:i},notify:{sms:d,email:p},reminder_enable:!0,notes:{purpose:"UPI Payment Link"},callback_url:"https://your-frontend-url.com/payment-status",callback_method:"get"});case 2:return y=e.v,e.p=3,e.n=4,gt({type:"LINK",timestamp:(new Date).toISOString(),description:u,email:s,phone:i,bdm:m,paymentLink:y.short_url,amount:o,status:"pending",name:a});case 4:e.n=6;break;case 5:e.p=5,g=e.v,console.error("Sheet logging failed:",g);case 6:return e.n=7,wt.create({customerName:a,contact:i,amount:o,user:f,description:u,link:y.short_url,status:"pending",createdOn:new Date});case 7:return e.a(2,r.status(200).json({success:!0,message:"Payment link created",payment_link_id:y.id,short_url:y.short_url}));case 8:e.p=8,b=e.v,console.error("❌ Razorpay Error:",b),r.status(500).json({message:(null===(v=b.error)||void 0===v?void 0:v.description)||b.message||"Payment link creation failed."});case 9:return e.a(2)}},e,null,[[3,5],[0,8]])}));return function(t,r){return e.apply(this,arguments)}}()),Et.post("/create-qr",N,function(){var e=Pt(kt().m(function e(t,r){var n,o,a,s,i,u,c,p,l,d,f,m,y,v,g,b,h,w,O,S,k;return kt().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,n=t.body,o=n.amount,a=n.user,s=n.name,i=n.description,u=n.customer_id,c=n.purpose,p=n.usage,l=n.fixed_amount,d=n.close_by_hours,f=n.userName,console.log(t.body),o&&s){e.n=1;break}return e.a(2,r.status(400).json({success:!1,message:"amount and name are required"}));case 1:return m=Math.floor(Date.now()/1e3)+(d?3600*d:86400),y={type:"upi_qr",name:s,usage:p||"single_use",fixed_amount:null==l||l,payment_amount:Math.round(100*o),description:i||"UPI QR Payment",close_by:m,notes:{purpose:c||"UPI QR Payment"}},u&&(y.customer_id=u),e.n=2,Tt.qrCode.create(y);case 2:return v=e.v,g=null,e.p=3,e.n=4,fetch(v.image_url);case 4:return b=e.v,e.n=5,b.arrayBuffer();case 5:h=e.v,g=Buffer.from(h).toString("base64"),e.n=7;break;case 6:e.p=6,O=e.v,console.error("Failed to fetch/convert QR image:",O);case 7:return Pt(kt().m(function e(){var t;return kt().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,gt({type:"QR",name:s,bdm:f,amount:o,description:i,qr_id:v.id,qr_image:v.image_url,usage:p,purpose:c,fixed_amount:l,close_by:m,status:"Pending"});case 1:e.n=3;break;case 2:e.p=2,t=e.v,console.error("Sheet logging failed:",t);case 3:return e.a(2)}},e,null,[[0,2]])}))(),w=null,e.p=8,e.n=9,St.create({name:s,user:a,amount:o,description:i,qr_id:v.id,qr_image:v.image_url,usage:p||"single_use",purpose:c||"UPI QR Payment",fixed_amount:null==l||l,close_by:m,qr_base64:g?"data:image/png;base64,".concat(g):null,status:"Pending",createdOn:new Date});case 9:w=e.v,e.n=11;break;case 10:e.p=10,S=e.v,console.error("Failed to save QR to DB:",S);case 11:return e.a(2,r.status(201).json({success:!0,message:"QR Code created",qr_id:v.id,qr_data:v,qr_base64:g?"data:image/png;base64,".concat(g):null,savedRecord:w}));case 12:return e.p=12,k=e.v,console.error("QR create error:",k),e.a(2,r.status(500).json({success:!1,message:k.message||"QR creation failed"}))}},e,null,[[8,10],[3,6],[0,12]])}));return function(t,r){return e.apply(this,arguments)}}()),Et.get("/payment-links",N,function(){var e=Pt(kt().m(function e(t,r){var n,o;return kt().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,wt.find().sort({createdOn:-1});case 1:n=e.v,r.json({success:!0,count:n.length,data:n}),e.n=3;break;case 2:e.p=2,o=e.v,r.status(500).json({success:!1,error:o.message});case 3:return e.a(2)}},e,null,[[0,2]])}));return function(t,r){return e.apply(this,arguments)}}()),Et.patch("/api/payment-links/:id/status",N,function(){var e=Pt(kt().m(function e(t,r){var n,o,a,s;return kt().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.params.id,o=t.body.status){e.n=1;break}return e.a(2,r.status(400).json({success:!1,message:"Status is required."}));case 1:return e.p=1,e.n=2,wt.findByIdAndUpdate(n,{$set:{status:o}},{new:!0,runValidators:!0});case 2:if(a=e.v){e.n=3;break}return e.a(2,r.status(404).json({success:!1,message:"Payment link not found."}));case 3:return e.a(2,r.status(200).json({success:!0,message:"Payment link status updated successfully.",data:a}));case 4:return e.p=4,s=e.v,console.error("Status update error:",s),e.a(2,r.status(500).json({success:!1,message:"Failed to update payment link status.",error:s.message}))}},e,null,[[1,4]])}));return function(t,r){return e.apply(this,arguments)}}()),Et.get("/api/payment-links/:id",N,function(){var e=Pt(kt().m(function e(t,r){var n,o,a;return kt().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=t.params.id,e.p=1,e.n=2,wt.findById(n);case 2:if(o=e.v){e.n=3;break}return e.a(2,r.status(404).json({success:!1,message:"Not found"}));case 3:r.json({success:!0,data:o}),e.n=5;break;case 4:e.p=4,a=e.v,r.status(400).json({success:!1,error:a.message});case 5:return e.a(2)}},e,null,[[1,4]])}));return function(t,r){return e.apply(this,arguments)}}()),Et.get("/qr-codes",N,function(){var e=Pt(kt().m(function e(t,r){var n,o,a,s;return kt().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=t.query.userId,o={},n&&(o.user=n),e.n=1,St.find(o).populate("user","name email user_role").sort({createdAt:-1});case 1:return a=e.v,e.a(2,r.status(200).json({success:!0,count:a.length,data:a}));case 2:return e.p=2,s=e.v,console.error("Get Payment QR Error:",s),e.a(2,r.status(500).json({success:!1,message:"Failed to fetch payment QR codes"}))}},e,null,[[0,2]])}));return function(t,r){return e.apply(this,arguments)}}());const At=Et;function It(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return Nt(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(Nt(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,Nt(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,Nt(l,"constructor",c),Nt(c,"constructor",u),u.displayName="GeneratorFunction",Nt(c,o,"GeneratorFunction"),Nt(l),Nt(l,o,"Generator"),Nt(l,n,function(){return this}),Nt(l,"toString",function(){return"[object Generator]"}),(It=function(){return{w:a,m:d}})()}function Nt(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}Nt=function(e,t,r,n){function a(t,r){Nt(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},Nt(e,t,r,n)}function xt(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}function qt(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){xt(a,n,o,s,i,"next",e)}function i(e){xt(a,n,o,s,i,"throw",e)}s(void 0)})}}var Rt=r.Router();Rt.post("/add",function(){var e=qt(It().m(function e(t,r){var n,o,a,s,i,u,c,p,l,d;return It().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.body,o=n.name,a=n.companyName,s=n.phoneNumber,i=n.email,u=n.location,c=n.service,p=n.message,o&&s&&i){e.n=1;break}return e.a(2,r.status(400).send({message:"name, phoneNumber and email are required"}));case 1:return e.p=1,e.n=2,He.findOne({email:i,phoneNumber:s});case 2:if(!e.v){e.n=3;break}return e.a(2,r.status(409).send({message:"Entry with same email and phone already exists"}));case 3:return e.n=4,He.create({name:o,companyName:a,phoneNumber:s,email:i,location:u,service:c,message:p});case 4:return l=e.v,e.a(2,r.status(201).send({message:"Email entry created",id:l._id,created:l}));case 5:return e.p=5,d=e.v,console.error(d),e.a(2,r.status(500).send({message:d.message}))}},e,null,[[1,5]])}));return function(t,r){return e.apply(this,arguments)}}()),Rt.get("/all",function(){var e=qt(It().m(function e(t,r){var n,o;return It().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,He.find().sort({createdAt:-1});case 1:return n=e.v,e.a(2,r.status(200).send(n));case 2:return e.p=2,o=e.v,console.error(o),e.a(2,r.status(500).send({message:o.message}))}},e,null,[[0,2]])}));return function(t,r){return e.apply(this,arguments)}}()),Rt.get("/:id",function(){var e=qt(It().m(function e(t,r){var n,o,a;return It().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=t.params.id,e.p=1,e.n=2,He.findById(n);case 2:if(o=e.v){e.n=3;break}return e.a(2,r.status(404).send({message:"Not found"}));case 3:return e.a(2,r.status(200).send(o));case 4:return e.p=4,a=e.v,console.error(a),e.a(2,r.status(500).send({message:a.message}))}},e,null,[[1,4]])}));return function(t,r){return e.apply(this,arguments)}}()),Rt.patch("/:id",function(){var e=qt(It().m(function e(t,r){var n,o,a,s;return It().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=t.params.id,o=t.body,e.p=1,e.n=2,He.findByIdAndUpdate(n,{$set:o},{new:!0});case 2:if(a=e.v){e.n=3;break}return e.a(2,r.status(404).send({message:"Not found"}));case 3:return e.a(2,r.status(200).send({message:"Updated successfully",updated:a}));case 4:return e.p=4,s=e.v,console.error(s),e.a(2,r.status(500).send({message:s.message}))}},e,null,[[1,4]])}));return function(t,r){return e.apply(this,arguments)}}()),Rt.delete("/:id",function(){var e=qt(It().m(function e(t,r){var n,o;return It().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.params.id,"srdev"===t.headers["user-role"]){e.n=1;break}return e.a(2,r.status(403).send({message:"Only srdev can permanently delete entries."}));case 1:return e.p=1,e.n=2,He.findById(n);case 2:if(e.v){e.n=3;break}return e.a(2,r.status(404).send({message:"Not found"}));case 3:return e.n=4,He.findByIdAndDelete(n);case 4:return e.a(2,r.status(200).send({message:"Deleted successfully"}));case 5:return e.p=5,o=e.v,console.error(o),e.a(2,r.status(500).send({message:o.message}))}},e,null,[[1,5]])}));return function(t,r){return e.apply(this,arguments)}}());const Gt=Rt;function Dt(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return Ct(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(Ct(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,Ct(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,Ct(l,"constructor",c),Ct(c,"constructor",u),u.displayName="GeneratorFunction",Ct(c,o,"GeneratorFunction"),Ct(l),Ct(l,o,"Generator"),Ct(l,n,function(){return this}),Ct(l,"toString",function(){return"[object Generator]"}),(Dt=function(){return{w:a,m:d}})()}function Ct(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}Ct=function(e,t,r,n){function a(t,r){Ct(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},Ct(e,t,r,n)}function Ft(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}e.config();var Ut=process.env.MAIL_USER,Bt=process.env.MAIL_PASS,Mt=r.Router();Mt.post("/api/welcome",function(){var e=function(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){Ft(a,n,o,s,i,"next",e)}function i(e){Ft(a,n,o,s,i,"throw",e)}s(void 0)})}}(Dt().m(function e(t,r){var n,o,a,s,i,u;return Dt().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=t.body,o=n.email,a=n.name,n.amount,e.p=1,s=j.createTransport({host:"smtp.hostinger.com",port:465,secure:!0,auth:{user:"".concat(Ut),pass:"".concat(Bt)}}),i={to:"".concat(o),from:"no-reply@finseraa.org",subject:"Warm Welcome to ".concat(a,"  from Finsera Ventures Private Limited\n"),html:"\n        <p>Dear Sir/Madam,</p>\n\n        <p>\n          We are pleased to extend a warm welcome to <b>".concat(a,"</b> as a valued client of \n          <b>Finsera Ventures Private Limited</b>. We sincerely appreciate the trust you’ve placed in us and are \n          excited about the opportunity to collaborate and contribute to your success.\n        </p>\n\n        <p>\n          At <b>Finsera Ventures Private Limited</b>, we are dedicated to offering high-quality, tailored services \n          designed to meet the unique needs of <b>").concat(a,"</b>. Our experienced team is committed to providing \n          expert support and guidance at every stage of our partnership to ensure a smooth and successful experience.\n        </p>\n\n        <p>\n          To facilitate a seamless process, one of our dedicated representatives will be in touch shortly \n          to coordinate with you and gather any necessary information. Please don’t hesitate to reach out \n          with any questions, concerns, or special requests. Your satisfaction is our highest priority, and \n          we are here to support you every step of the way.\n        </p>\n\n        <p>\n          Thank you once again for choosing <b>Finsera Ventures Private Limited</b>. We look forward to a successful \n          and fruitful collaboration, and to helping <b>").concat(a,'</b> achieve its business objectives.\n        </p>\n\n        <p>\n          For any queries kindly mail us at <a href="mailto:support@finseraa.org">support@finseraa.org</a>\n        </p>\n\n        <p style="color: #555; font-size: 14px; margin-top: 20px;">\n          <i>This is a system-generated email. Please do not reply to this email.</i>\n        </p>\n\n        <p>Warm regards,</p>\n        <p><b>Finsera Ventures Private Limited</b></p>\n        <p><a href="https://Finseraa.com">Finseraa.com</a></p>\n      ')},e.n=2,s.sendMail(i);case 2:r.status(200).json({message:"Welcome Mail Sent Successfully."}),e.n=4;break;case 3:e.p=3,u=e.v,r.status(500).json({message:"Server error.",error:u.message});case 4:return e.a(2)}},e,null,[[1,3]])}));return function(t,r){return e.apply(this,arguments)}}());const Lt=Mt;var $t=r.Router();$t.get("/",function(e,t){t.status(200).json({status:"ok",time:(new Date).toISOString()})});const Yt=$t;var Vt=(0,r.Router)();Vt.use("/user",$),Vt.use("/booking",X),Vt.use("/services",ie),Vt.use("/employee",Ce),Vt.use("/invoice",Ve),Vt.use("/leads",Xe),Vt.use("/admin",st),Vt.use("/payments",At),Vt.use("/email",Gt),Vt.use("/mail",Lt),Vt.use("/health",Yt);const Kt=Vt;require("swagger-ui-express"),require("swagger-jsdoc")({definition:{openapi:"3.0.0",info:{title:"CRM Backend API",version:"1.0.0",description:"API documentation for CRM Backend",contact:{name:"Rizvan",email:"rizvan@finseraa.com",url:"https://rizvan.is-a.dev/"}},servers:[{url:"http://localhost:5353",description:"Local server"},{url:"https://your-production-domain.com",description:"Production server"}],components:{securitySchemes:{authToken:{type:"apiKey",in:"header",name:"authorization",description:"JWT token (NO Bearer prefix)"}},schemas:{Booking:{type:"object",properties:{_id:{type:"string"},user_id:{type:"string"},bdm:{type:"string"},branch_name:{type:"string"},company_name:{type:"string"},contact_person:{type:"string"},email:{type:"string"},contact_no:{type:"string"},services:{type:"array",items:{type:"string"}},total_amount:{type:"number"},payment_date:{type:"string",format:"date-time"},status:{type:"string"},bank:{type:"string"},state:{type:"string"},isDeleted:{type:"boolean"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"}}},LeadModel:{type:"object",properties:{_id:{type:"string"},name:{type:"string"},companyName:{type:"string"},phoneNumber:{type:"string"},email:{type:"string"},location:{type:"string"},service:{type:"string"},message:{type:"string"},assignedTo:{type:"string",example:"unassigned"},isDeleted:{type:"boolean",example:!1},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"}}},EmployeeModel:{type:"object",properties:{userId:{type:"string"},employeeId:{type:"string"},employeeFullName:{type:"string"},designation:{type:"string"},department:{type:"string"},branch:{type:"string"},gender:{type:"string"},maritalStatus:{type:"string"},dateOfBirth:{type:"string",format:"date"},dateOfJoining:{type:"string",format:"date"},reportingManager:{type:"string"},personalEmailAddress:{type:"string"},workEmail:{type:"string"},personalContactNumber:{type:"string"},workPhoneNumber:{type:"string"},profileCompletionStatus:{type:"string",example:"approved"},isActive:{type:"boolean"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"}}},paymentLinkModel:{type:"object",required:["customer","contact","amount","bdm","link"],properties:{customer:{type:"string",example:"Rahul Sharma"},contact:{type:"string",example:"9876543210"},amount:{type:"number",minimum:1,example:15e3},bdm:{type:"string",example:"BDM001",description:"Business Development Manager ID or Name"},description:{type:"string",example:"GST filing payment"},link:{type:"string",example:"https://rzp.io/i/AbCdEf"},status:{type:"string",enum:["PENDING","PAID","EXPIRED","FAILED"],example:"PENDING"}}},paymentQRModel:{type:"object",required:["name","amount","qr_id"],properties:{name:{type:"string",example:"Rahul Sharma"},bdm:{type:"string",example:"BDM001",description:"Business Development Manager identifier"},amount:{type:"number",example:25e3},description:{type:"string",example:"UPI QR payment for GST filing"},qr_id:{type:"string",example:"qr_FGk92kLmPq",description:"Unique Razorpay QR ID"},qr_image:{type:"string",example:"https://api.razorpay.com/v1/qr_codes/qr_FGk92kLmPq"},usage:{type:"string",example:"single_use"},purpose:{type:"string",example:"UPI QR Payment"},fixed_amount:{type:"boolean",example:!0},close_by:{type:"number",example:1735689600,description:"Unix timestamp when QR expires"},status:{type:"string",enum:["Pending","Paid","Expired","Cancelled"],example:"Pending"}}},ServiceModel:{type:"object",properties:{_id:{type:"string"},label:{type:"string"},value:{type:"string"},status:{type:"string",example:"active"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"}}},UserModel:{type:"object",properties:{_id:{type:"string"},name:{type:"string"},email:{type:"string"},user_role:{type:"string",example:"admin"},isActive:{type:"boolean",example:!0},createdAt:{type:"string",format:"date-time"}}},InvoiceModel:{type:"object",properties:{_id:{type:"string"},invoiceNumber:{type:"string"},customerName:{type:"string"},customerEmail:{type:"string"},amount:{type:"number"},taxAmount:{type:"number"},totalAmount:{type:"number"},status:{type:"string"},dueDate:{type:"string",format:"date"},createdAt:{type:"string",format:"date-time"},updatedAt:{type:"string",format:"date-time"}}}}},security:[{authToken:[]}]},apis:["./src/api/v1/routes/**/*.js"]});var Ht=r();Ht.use(r.json()),Ht.use(n({origin:"*",methods:["GET","POST","PUT","DELETE","PATCH"],allowedHeaders:["Content-Type","Authorization","user-role"]})),Ht.use(b),Ht.use("/api/v1",Kt),Ht.get("/",function(e,t){t.send("✅ Server running")});const Wt=Ht;function zt(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return Qt(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(Qt(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,Qt(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,Qt(l,"constructor",c),Qt(c,"constructor",u),u.displayName="GeneratorFunction",Qt(c,o,"GeneratorFunction"),Qt(l),Qt(l,o,"Generator"),Qt(l,n,function(){return this}),Qt(l,"toString",function(){return"[object Generator]"}),(zt=function(){return{w:a,m:d}})()}function Qt(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}Qt=function(e,t,r,n){function a(t,r){Qt(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},Qt(e,t,r,n)}function Jt(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}e.config(),process.env.PORT;var Zt=function(){var e=function(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){Jt(a,n,o,s,i,"next",e)}function i(e){Jt(a,n,o,s,i,"throw",e)}s(void 0)})}}(zt().m(function e(){var t,r;return zt().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,h.connect(process.env.MONGO_URI);case 1:t=e.v,console.log("MongoDB Connected: ".concat(t.connection.host)),e.n=3;break;case 2:e.p=2,r=e.v,console.log({msg:"cannot connect to db",error:r.message}),process.exit(1);case 3:return e.a(2)}},e,null,[[0,2]])}));return function(){return e.apply(this,arguments)}}(),Xt=a.createLogger,er=a.format,tr=a.transports,rr=new tr.DailyRotateFile({filename:"logs/%DATE%-error.log",datePattern:"YYYY-MM-DD",level:"error",maxSize:"10m",maxFiles:"30d"});const nr=Xt({level:"error",format:er.combine(er.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),er.json()),transports:[new tr.Console,rr]}),or=require("node-cron");function ar(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return sr(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(sr(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,sr(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,sr(l,"constructor",c),sr(c,"constructor",u),u.displayName="GeneratorFunction",sr(c,o,"GeneratorFunction"),sr(l),sr(l,o,"Generator"),sr(l,n,function(){return this}),sr(l,"toString",function(){return"[object Generator]"}),(ar=function(){return{w:a,m:d}})()}function sr(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}sr=function(e,t,r,n){function a(t,r){sr(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},sr(e,t,r,n)}function ir(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}function ur(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){ir(a,n,o,s,i,"next",e)}function i(e){ir(a,n,o,s,i,"throw",e)}s(void 0)})}}var cr=process.env.KEEP_ALIVE_URL,pr=!1;function lr(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return dr(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(dr(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,dr(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,dr(l,"constructor",c),dr(c,"constructor",u),u.displayName="GeneratorFunction",dr(c,o,"GeneratorFunction"),dr(l),dr(l,o,"Generator"),dr(l,n,function(){return this}),dr(l,"toString",function(){return"[object Generator]"}),(lr=function(){return{w:a,m:d}})()}function dr(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}dr=function(e,t,r,n){function a(t,r){dr(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},dr(e,t,r,n)}function fr(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return mr(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?mr(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,i=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){i=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(i)throw a}}}}function mr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function yr(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}function vr(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){yr(a,n,o,s,i,"next",e)}function i(e){yr(a,n,o,s,i,"throw",e)}s(void 0)})}}var gr=!1;function br(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof i?n:i,c=Object.create(u.prototype);return hr(c,"_invoke",function(r,n,o){var a,i,u,c=0,p=o||[],l=!1,d={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,r){return a=t,i=0,u=e,d.n=r,s}};function f(r,n){for(i=r,u=n,t=0;!l&&c&&!o&&t<p.length;t++){var o,a=p[t],f=d.p,m=a[2];r>3?(o=m===n)&&(u=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=f&&((o=r<2&&f<a[1])?(i=0,d.v=n,d.n=a[1]):f<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,d.n=m,i=0))}if(o||r>1)return s;throw l=!0,n}return function(o,p,m){if(c>1)throw TypeError("Generator is already running");for(l&&1===p&&f(p,m),i=p,u=m;(t=i<2?e:u)||!l;){a||(i?i<3?(i>1&&(d.n=-1),f(i,u)):d.n=u:d.v=u);try{if(c=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(l=d.n<0)?u:r.call(n,d))!==s)break}catch(t){a=e,i=1,u=t}finally{c=1}}return{value:t,done:l}}}(r,o,a),!0),c}var s={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var p=[][n]?t(t([][n]())):(hr(t={},n,function(){return this}),t),l=c.prototype=i.prototype=Object.create(p);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,hr(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=c,hr(l,"constructor",c),hr(c,"constructor",u),u.displayName="GeneratorFunction",hr(c,o,"GeneratorFunction"),hr(l),hr(l,o,"Generator"),hr(l,n,function(){return this}),hr(l,"toString",function(){return"[object Generator]"}),(br=function(){return{w:a,m:d}})()}function hr(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}hr=function(e,t,r,n){function a(t,r){hr(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},hr(e,t,r,n)}function wr(e,t,r,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}e.config({path:t.resolve(process.cwd(),".env")}),process.on("uncaughtException",function(e){nr.error("Uncaught Exception",e),process.exit(1)}),process.on("unhandledRejection",function(e){nr.error("Unhandled Rejection",e)});var Or=function(){var e=function(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function s(e){wr(a,n,o,s,i,"next",e)}function i(e){wr(a,n,o,s,i,"throw",e)}s(void 0)})}}(br().m(function e(){var t;return br().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,Zt();case 1:g.info("✅ Database connected"),Wt.listen(d.server.port,function(){g.info("🚀 Server running on port ".concat(d.server.port)),d.isProd&&process.env.KEEP_ALIVE_URL&&(cr?pr?console.warn("[CRON] Keep-alive already running, skipping duplicate start"):(or.schedule("*/8 * * * *",ur(ar().m(function e(){var t,r,n,o;return ar().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,t=new AbortController,r=setTimeout(function(){return t.abort()},1e4),e.n=1,fetch(cr,{signal:t.signal});case 1:n=e.v,clearTimeout(r),console.log("[CRON] Keep-alive OK ".concat(n.status," @ ").concat((new Date).toISOString())),e.n=3;break;case 2:e.p=2,o=e.v,console.error("[CRON] Keep-alive failed:",o.message);case 3:return e.a(2)}},e,null,[[0,2]])})),{scheduled:!0,timezone:"UTC"}),pr=!0,console.log("[CRON] Keep-alive started (production)")):console.warn("[CRON] KEEP_ALIVE_URL not set, skipping keep-alive cron"),gr?console.warn("[CRON] deleteDuplicates already running"):(or.schedule("0 0 * * *",vr(lr().m(function e(){var t,r,n,o,a,s,i,u,c,p;return lr().w(function(e){for(;;)switch(e.p=e.n){case 0:return console.log("🧹 [CRON] Checking for duplicate leads..."),e.p=1,e.n=2,He.find({},{email:1,phoneNumber:1});case 2:t=e.v,r=new Set,n=[],o=fr(t),e.p=3,o.s();case 4:if((a=o.n()).done){e.n=7;break}if(s=a.value,i="".concat(s.email||"","-").concat(s.phoneNumber||"").trim()){e.n=5;break}return e.a(3,6);case 5:r.has(i)?n.push(s._id):r.add(i);case 6:e.n=4;break;case 7:e.n=9;break;case 8:e.p=8,c=e.v,o.e(c);case 9:return e.p=9,o.f(),e.f(9);case 10:if(!(n.length>0)){e.n=12;break}return e.n=11,He.deleteMany({_id:{$in:n}});case 11:u=e.v,console.log("🗑️ [CRON] Deleted ".concat(u.deletedCount," duplicate leads")),e.n=13;break;case 12:console.log("✅ [CRON] No duplicate leads found");case 13:e.n=15;break;case 14:e.p=14,p=e.v,console.error("❌ [CRON] deleteDuplicates failed:",p.message);case 15:return e.a(2)}},e,null,[[3,8,9,10],[1,14]])})),{scheduled:!0,timezone:"UTC"}),gr=!0,console.log("[CRON] deleteDuplicates started")))}),e.n=3;break;case 2:e.p=2,t=e.v,g.error("❌ Failed to start server",t),process.exit(1);case 3:return e.a(2)}},e,null,[[0,2]])}));return function(){return e.apply(this,arguments)}}();Or()})();